<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' https://cdn.jsdelivr.net https://telegram.org 'unsafe-inline'; connect-src 'self' https://xtjijqrycwudjdsjngjb.supabase.co https://api.telegram.org; img-src 'self' https://i.postimg.cc https://images.unsplash.com">
    <title>Dark Thailand - Надёжный шоп</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #1a1a1a 0%, #2b0000 100%);
            color: #ff4444;
            overflow-x: hidden;
        }
        .container { max-width: 600px; margin: 0 auto; padding: 15px; position: relative; }
        .header { text-align: center; padding: 15px 0; background-color: #2b2b2b; color: #ff4444; margin-bottom: 20px; border-radius: 5px; border: 2px solid #ff4444; box-shadow: 0 0 10px rgba(255, 68, 68, 0.5); }
        .logo { font-size: 48px; animation: textPulse 2s infinite; display: inline-block; }
        @keyframes textPulse { 0% { transform: scale(1); text-shadow: 0 0 5px #ff4444; } 50% { transform: scale(1.05); text-shadow: 0 0 20px #ff4444, 0 0 30px #ff6666; } 100% { transform: scale(1); text-shadow: 0 0 5px #ff4444; } }
        .header-text { font-size: 16px; margin-top: 5px; animation: textFlicker 3s infinite; }
        @keyframes textFlicker { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .nav { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .nav-button { background-color: #ff4444; color: #000; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; animation: neonPulse 1.5s infinite; }
        .profile-button { background-color: #ff4444; color: #000; border: none; padding: 0; border-radius: 5px; cursor: pointer; font-size: 26px; width: 60px; height: 40px; line-height: 40px; text-align: center; animation: neonPulse 1.5s infinite; }
        @keyframes neonPulse { 0% { box-shadow: 0 0 5px #ff4444; } 50% { box-shadow: 0 0 20px #ff4444; } 100% { box-shadow: 0 0 5px #ff4444; } }
        .catalog-menu, .profile-menu, .vacancy-menu, .mail-menu { display: none; background-color: #333; border-radius: 5px; padding: 15px; box-shadow: 0 0 15px rgba(255, 68, 68, 0.3); }
        .city-filter { margin-bottom: 15px; }
        .city-filter select, .district-filter select { width: 100%; padding: 10px; background-color: #2b2b2b; color: #ff4444; border: 1px solid #ff4444; border-radius: 5px; font-size: 16px; margin-bottom: 10px; }
        .tabs { display: flex; flex-wrap: wrap; margin-bottom: 15px; }
        .tab { flex: 1; text-align: center; padding: 10px; background-color: #2b2b2b; cursor: pointer; margin: 5px; border-radius: 5px; transition: all 0.3s; }
        .tab:hover { background-color: #ff6666; }
        .tab.active { background-color: #ff4444; color: #000; box-shadow: 0 0 10px #ff4444; }
        .tab-content { display: none; }
        .product-card { background-color: #333; border-radius: 5px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(255, 68, 68, 0.3); transition: transform 0.2s; }
        .product-card:hover { transform: scale(1.02); }
        .product-card h3 { margin-top: 0; color: #ff6666; cursor: pointer; }
        .product-card p { margin: 5px 0; }
        .product-image { width: 100%; max-height: 150px; object-fit: cover; border-radius: 5px; margin-bottom: 10px; }
        .price { font-weight: bold; color: #ff9999; }
        .crypto-price { font-size: 12px; color: #ff6666; }
        .buy-button, .preorder-button { background-color: #ff4444; color: #000; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin: 5px 0; width: 100%; transition: all 0.3s; }
        .preorder-button { background-color: #ff6666; }
        .buy-button:hover, .preorder-button:hover { background-color: #ff8888; }
        .payment-modal, .product-modal, .deposit-modal, .preorder-modal, .registration-modal, .custom-modal, .confirm-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); justify-content: center; align-items: center; }
        .payment-content, .product-content, .deposit-content, .preorder-content, .registration-content, .custom-content, .confirm-content { background: #333; padding: 20px; border-radius: 5px; text-align: center; color: #ff4444; max-width: 500px; max-height: 80vh; overflow-y: auto; border: 2px solid #ff4444; box-shadow: 0 0 15px rgba(255, 68, 68, 0.5); }
        .review { background-color: #2b2b2b; border-left: 4px solid #ff6666; padding: 10px; margin: 10px 0; font-size: 12px; color: #ff9999; text-align: left; display: flex; justify-content: space-between; }
        .review-text { flex-grow: 1; }
        .review-date { flex-shrink: 0; margin-left: 10px; color: #ff6666; }
        .moderator-response { background-color: #2b2b2b; border-left: 4px solid #ff4444; padding: 10px; margin: 5px 0 10px 20px; font-size: 12px; color: #ff6666; text-align: left; }
        .position { margin: 10px 0; text-align: left; }
        .promo-banner { background-color: #ff4444; color: #000; padding: 10px; text-align: center; margin-bottom: 20px; border-radius: 5px; font-weight: bold; }
        .vacancy { margin-bottom: 15px; }
        .vacancy h3 { color: #ff6666; }
        input[type="text"], textarea, input[type="number"], select, input[type="password"] { width: 100%; padding: 10px; margin: 10px 0; background-color: #2b2b2b; color: #ff4444; border: 1px solid #ff4444; border-radius: 5px; }
        textarea { height: 100px; resize: none; }
    </style>
</head>
<body>
    <div id="alertModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span id="alertMessage"></span>
            <button class="close-button" onclick="hideModal('alertModal')">Закрыть</button>
        </div>
    </div>
    
    <div class="container">
        <div class="promo-banner" id="promoBanner"></div>

        <div class="header">
            <div class="logo">Dark Thailand</div>
            <div class="header-text" id="headerText"></div>
        </div>
        
        <div class="nav">
            <button class="nav-button" id="catalogButton" onclick="toggleCatalog()"></button>
            <button class="nav-button" id="vacanciesButton" onclick="toggleVacancies()"></button>
            <button class="nav-button" id="mailButton" onclick="toggleMail()"></button>
            <button class="profile-button" onclick="toggleProfile()">☠️</button>
        </div>
        
        <div class="catalog-menu" id="catalogMenu">
            <div class="city-filter">
                <select id="citySelect" onchange="filterByCity()">
                    <option value="all" id="allCitiesOption"></option>
                    <option value="phuket" id="phuketOption"></option>
                    <option value="pattaya" id="pattayaOption"></option>
                    <option value="bangkok" id="bangkokOption"></option>
                    <option value="samui" id="samuiOption"></option>
                </select>
                <select id="districtSelect" onchange="filterByDistrict()">
                    <option value="all" id="allDistrictsOption"></option>
                </select>
            </div>
            <div class="tabs">
                <div class="tab" data-tab="weed" id="weedTab">Марихуана</div>
                <div class="tab" data-tab="hash" id="hashTab">Гашиш</div>
                <div class="tab" data-tab="coke" id="cokeTab">Кокаин</div>
                <div class="tab" data-tab="amph" id="amphTab">Амфетамин</div>
                <div class="tab" data-tab="meth" id="methTab">Метамфетамин</div>
                <div class="tab" data-tab="meph" id="mephTab">Мефедрон</div>
                <div class="tab" data-tab="alpha" id="alphaTab">Альфа-PVP</div>
                <div class="tab" data-tab="lsd" id="lsdTab">ЛСД</div>
                <div class="tab" data-tab="mdma" id="mdmaTab">МДМА</div>
                <div class="tab" data-tab="heroin" id="heroinTab">Героин</div>
            </div>

            <div id="weed" class="tab-content">
                <div class="product-card" data-product="weed-1">
                    <img src="https://i.postimg.cc/nMGvf409/jamaican-haze.jpg" class="product-image" alt="OG Kush">
                    <h3 onclick="showProductModal('weed', 1)">OG Kush 70% (VHQ)</h3>
                    <p id="weedDesc"></p>
                </div>
            </div>

            <div id="hash" class="tab-content">
                <div class="product-card" data-product="hash-1">
                    <img src="https://i.postimg.cc/sD11WBq4/image.jpg" class="product-image" alt="Ice-o-lator">
                    <h3 onclick="showProductModal('hash', 1)">Ice-o-lator (VHQ)</h3>
                    <p>Премиум гашиш, бархатный эффект</p>
                </div>
                <div class="product-card" data-product="hash-2">
                    <img src="https://i.postimg.cc/KjjctVq8/image.png" class="product-image" alt="Moroccan Spice">
                    <h3 onclick="showProductModal('hash', 2)">Moroccan Spice (HQ)</h3>
                    <p>Марокканский гашиш с пряным ароматом</p>
                </div>
                <div class="product-card" data-product="hash-3">
                    <img src="https://i.postimg.cc/2ygYh5L0/image.jpg" class="product-image" alt="Euro">
                    <h3 onclick="showProductModal('hash', 3)">Euro (MQ)</h3>
                    <p>Европейский, сбалансированный приход</p>
                </div>
            </div>

            <div id="coke" class="tab-content">
                <div class="product-card" data-product="coke-1">
                    <img src="https://i.postimg.cc/3W512jLd/image.jpg" class="product-image" alt="Bolivian Fishscale">
                    <h3 onclick="showProductModal('coke', 1)">Bolivian Fishscale (VHQ)</h3>
                    <p>Боливийский кокаин, топовый 95%+</p>
                </div>
                <div class="product-card" data-product="coke-2">
                    <img src="https://i.postimg.cc/xTLDh6Vp/2.jpg" class="product-image" alt="Colombian Snow">
                    <h3 onclick="showProductModal('coke', 2)">Colombian Snow (HQ)</h3>
                    <p>Колумбийский снег, чистый и мощный</p>
                </div>
            </div>

            <div id="amph" class="tab-content">
                <div class="product-card" data-product="amph-1">
                    <img src="https://i.postimg.cc/3Jgrmg9p/image.jpg" class="product-image" alt="White Rabbit">
                    <h3 onclick="showProductModal('amph', 1)">White Rabbit (VHQ)</h3>
                    <p>Чистейший амфетамин, чистая энергия</p>
                </div>
                <div class="product-card" data-product="amph-2">
                    <img src="https://i.postimg.cc/90y2PhPV/image.jpg" class="product-image" alt="Red Rush">
                    <h3 onclick="showProductModal('amph', 2)">Red Rush (HQ)</h3>
                    <p>Красный заряд, стабильный драйв</p>
                </div>
                <div class="product-card" data-product="amph-3">
                    <img src="https://i.postimg.cc/BvtGYD5m/image.jpg" class="product-image" alt="Yellow Spark">
                    <h3 onclick="showProductModal('amph', 3)">Yellow Spark (MQ)</h3>
                    <p>Жёлтая искра, средний подъём</p>
                </div>
                <div class="product-card" data-product="amph-4">
                    <img src="https://i.postimg.cc/qMX0zpMx/image.jpg" class="product-image" alt="Grey Haze">
                    <h3 onclick="showProductModal('amph', 4)">Grey Haze (LQ)</h3>
                    <p>Серая дымка, базовый вариант</p>
                </div>
            </div>

            <div id="meth" class="tab-content">
                <div class="product-card" data-product="meth-1">
                    <img src="https://i.postimg.cc/dVPkKsNR/image.jpg" class="product-image" alt="Mountain Ice">
                    <h3 onclick="showProductModal('meth', 1)">Mountain Ice (VHQ)</h3>
                    <p>Горный лёд, кристальная чистота</p>
                </div>
                <div class="product-card" data-product="meth-2">
                    <img src="https://i.postimg.cc/765jVVNV/image.jpg" class="product-image" alt="Blue Flame">
                    <h3 onclick="showProductModal('meth', 2)">Blue Flame (HQ)</h3>
                    <p>Синее пламя, долгий эффект</p>
                </div>
            </div>

            <div id="meph" class="tab-content">
                <div class="product-card" data-product="meph-1">
                    <img src="https://i.postimg.cc/4NMvHRLn/image.jpg" class="product-image" alt="Meph Crystal">
                    <h3 onclick="showProductModal('meph', 1)">Meph Crystal (VHQ)</h3>
                    <p>Меф кристалл, чистейший кайф</p>
                </div>
                <div class="product-card" data-product="meph-2">
                    <img src="https://i.postimg.cc/prxYTVyF/image.jpg" class="product-image" alt="White Surge">
                    <h3 onclick="showProductModal('meph', 2)">White Surge (HQ)</h3>
                    <p>Белый всплеск, стабильный эффект</p>
                </div>
                <div class="product-card" data-product="meph-3">
                    <img src="https://i.postimg.cc/ZqLycGc8/vava.jpg" class="product-image" alt="Grey Mist">
                    <h3 onclick="showProductModal('meph', 3)">Grey Mist (MQ)</h3>
                    <p>Меф, средний уровень</p>
                </div>
            </div>

            <div id="alpha" class="tab-content">
                <div class="product-card" data-product="alpha-1">
                    <img src="https://i.postimg.cc/hjmpv3rH/image.jpg" class="product-image" alt="Flakka Fire">
                    <h3 onclick="showProductModal('alpha', 1)">Flakka Fire (VHQ)</h3>
                    <p>Огненная флакка, чистый Альфа-PVP</p>
                </div>
                <div class="product-card" data-product="alpha-2">
                    <img src="https://i.postimg.cc/4x3PV3Pv/image.jpg" class="product-image" alt="Blue Haze">
                    <h3 onclick="showProductModal('alpha', 2)">Blue Haze (HQ)</h3>
                    <p>Синяя дымка, мощный заряд</p>
                </div>
                <div class="product-card" data-product="alpha-3">
                    <img src="https://i.postimg.cc/TwHC3LBH/image.jpg" class="product-image" alt="Green Dust">
                    <h3 onclick="showProductModal('alpha', 3)">Green Dust (MQ)</h3>
                    <p>Зелёная пыль, средний эффект</p>
                </div>
                <div class="oplasty-product-card" data-product="alpha-4">
                    <img src="https://i.postimg.cc/yNLw0Nw0/image.jpg" class="product-image" alt="Crystal Fury">
                    <h3 onclick="showProductModal('alpha', 4)">Crystal Fury (VHQ)</h3>
                    <p>Кристальная ярость, топовый PVP</p>
                </div>
            </div>

            <div id="lsd" class="tab-content">
                <div class="product-card" data-product="lsd-1">
                    <img src="https://i.postimg.cc/yNHGMRzm/250.jpg" class="product-image" alt="Cosmic Tabs">
                    <h3 onclick="showProductModal('lsd', 1)">Cosmic Tabs (VHQ)</h3>
                    <p>LSD250, чистый трип</p>
                </div>
                <div class="product-card" data-product="lsd-2">
                    <img src="https://i.postimg.cc/Xqp1fcwb/image.jpg" class="product-image" alt="Neon Drops">
                    <h3 onclick="showProductModal('lsd', 2)">Neon Drops (HQ)</h3>
                    <p>LSD190, яркий опыт</p>
                </div>
            </div>

            <div id="mdma" class="tab-content">
                <div class="product-card" data-product="mdma-1">
                    <img src="https://i.postimg.cc/521GGvJw/image.jpg" class="product-image" alt="Crystal Love">
                    <h3 onclick="showProductModal('mdma', 1)">Crystal Love (VHQ)</h3>
                    <p>Кристальная любовь, чистый МДМА</p>
                </div>
                <div class="product-card" data-product="mdma-2">
                    <img src="https://i.postimg.cc/Z5y9Gt5t/image.jpg" class="product-image" alt="Pink Hearts">
                    <h3 onclick="showProductModal('mdma', 2)">Pink Hearts (HQ)</h3>
                    <p>Розовые сердца, стабильный кайф</p>
                </div>
                <div class="product-card" data-product="mdma-3">
                    <img src="https://i.postimg.cc/SRCT1QtT/image.jpg" class="product-image" alt="Ecstasy Givenchy">
                    <h3 onclick="showProductModal('mdma', 3)">Ecstasy Givenchy (VHQ Tabs)</h3>
                    <p>Givenchy, топовые пилсы</p>
                </div>
                <div class="product-card" data-product="mdma-4">
                    <img src="https://i.postimg.cc/52j5jR9n/image.jpg" class="product-image" alt="Street Pills">
                    <h3 onclick="showProductModal('mdma', 4)">Street Pills</h3>
                    <p>Уличные пилсы, бюджетный экстази</p>
                </div>
            </div>

            <div id="heroin" class="tab-content">
                <div class="product-card" data-product="heroin-1">
                    <img src="https://i.postimg.cc/gkX1RN0k/image.jpg" class="product-image" alt="Afghan Silk">
                    <h3 onclick="showProductModal('heroin', 1)">Afghan Silk (VHQ)</h3>
                    <p>Афганский шёлк, глубокий приход</p>
                </div>
                <div class="product-card" data-product="heroin-2">
                    <img src="https://i.postimg.cc/Nj8J7VvY/image.jpg" class="product-image" alt="White Lotus">
                    <h3 onclick="showProductModal('heroin', 2)">White Lotus (HQ)</h3>
                    <p>Белый лотос, чистый эффект</p>
                </div>
            </div>
        </div>

        <div class="product-modal" id="productModal">
            <div class="product-content" id="productContent"></div>
        </div>

        <div class="profile-menu" id="profileMenu">
    <div class="profile-info">
        <h3>☠️</h3>
        <p id="profileNameLabel"></p>
        <p>Баланс: <span id="balance">0 ฿</span></p>
        <p id="ordersLabel"></p>
        <p id="referralsLabel"></p>
    </div>
<div class="promo-info">
        <p id="promoInfo"></p>
        <button class="nav-button" onclick="showPromoDetails()">Подробнее</button>
    </div>
    <div class="deposit-options">
        <h3 id="depositTitle"></h3>
        <button class="nav-button" onclick="showDepositModal('BTC')">Bitcoin (BTC)</button>
        <button class="nav-button" onclick="showDepositModal('ETH')">Ethereum (ETH)</button>
        <button class="nav-button" onclick="showDepositModal('USDT')">Tether (USDT)</button>
        <button class="nav-button" onclick="showDepositModal('SOL')">Solana (SOL)</button>
        <button class="nav-button" onclick="showDepositModal('TON')">Toncoin (TON)</button>
    </div>
    <div class="order-history">
        <h3 id="orderHistoryTitle"></h3>
        <div id="orderList"></div>
    </div>
    <button class="nav-button" id="logoutButton" onclick="logout()">Выйти</button>
</div>

<style>
    #logoutButton {
        background-color: #ff5555;
        margin-top: 10px;
    }

    #logoutButton:hover {
        background-color: #ff7777;
    }
.login-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    justify-content: center;
    align-items: center;
}

.login-content {
    background: #333;
    padding: 20px;
    border-radius: 5px;
    text-align: center;
    color: #ff4444;
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
    border: 2px solid #ff4444;
    box-shadow: 0 0 15px rgba(255, 68, 68, 0.5);
}
</style>

        <div class="vacancy-menu" id="vacancyMenu">
            <h2 id="vacanciesTitle">Вакансии</h2>
            <div class="vacancy">
                <h3 id="courierTitle">Кладмен</h3>
                <p id="courierDuties">Обязанности: Делать клады.</p>
                <p id="courierPay">Оплата: от 100000 батт/месяц</p>
                <button class="buy-button" onclick="applyForJob('Кладмен')" id="applyButton1">Откликнуться</button>
            </div>
            <div class="vacancy">
                <h3 id="warehousemanTitle">Складмен</h3>
                <p id="warehousemanDuties">Обязанности: Приём больших партий, делать мастер-клады для кладменов.</p>
                <p id="warehousemanPay">Оплата: от 200000 батт/месяц</p>
                <button class="buy-button" onclick="applyForJob('Складмен')" id="applyButton2">Откликнуться</button>
            </div>
            <div class="vacancy">
                <h3 id="transporterTitle">Перевозчик</h3>
                <p id="transporterDuties">Обязанности: перевозка товара по всему Тайланду.</p>
                <p id="transporterPay">Оплата: от 350000 батт/месяц</p>
                <button class="buy-button" onclick="applyForJob('Перевозчик')" id="applyButton3">Откликнуться</button>
            </div>
            <div class="vacancy">
                <h3 id="smmTitle">SMMщик</h3>
                <p id="smmDuties">Обязанности: Рекламировать магазин</p>
                <p id="smmPay">Оплата: от 70000 батт/неделя</p>
                <button class="buy-button" onclick="applyForJob('SMMщик')" id="applyButton4">Откликнуться</button>
            </div>
        </div>

        <div class="mail-menu" id="mailMenu">
            <h2 id="mailTitle"></h2>
            <div id="mailList"></div>
        </div>

        <div class="payment-modal" id="paymentModal">
            <div class="payment-content" id="paymentContent"></div>
        </div>

        <div class="deposit-modal" id="depositModal">
            <div class="deposit-content" id="depositContent"></div>
        </div>

        <div class="preorder-modal" id="preorderModal">
            <div class="preorder-content" id="preorderContent"></div>
        </div>

        <div id="registrationModal" class="registration-modal">
            <div class="registration-content">
                <h2>Регистрация</h2>
                <input type="text" id="regNickname" placeholder="Nickname (a-z, A-Z, max 12)" maxlength="12">
                <input type="password" id="regPassword" placeholder="Password">
                <select id="regLanguage">
                    <option value="ru">Русский</option>
                    <option value="en">English</option>
                    <option value="th">ไทย</option>
                </select>
                <button class="buy-button" onclick="registerUser()">Зарегистрироваться</button>
                <button class="buy-button" onclick="hideRegistrationModal()">Отмена</button>
            </div>
        </div>

<div id="loginModal" class="login-modal">
    <div class="login-content">
        <h2>Авторизация</h2>
        <input type="text" id="loginNickname" placeholder="Nickname">
        <input type="password" id="loginPassword" placeholder="Password">
        <button class="buy-button" onclick="loginUser()">Войти</button>
        <button class="buy-button" onclick="showRegistrationFromLogin()">Зарегистрироваться</button>
    </div>
</div>

        <div class="custom-modal" id="customModal">
            <div class="custom-content" id="customContent"></div>
        </div>

        <div class="confirm-modal" id="confirmModal">
            <div class="confirm-content" id="confirmContent"></div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
<script>
    window.addEventListener('load', () => {
        console.log('Окно загружено');
        if (typeof Supabase === 'undefined') {
            console.error('Supabase SDK не загрузился!');
        } else {
            console.log('Supabase SDK загружен:', Supabase);
            try {
                window.supabase = Supabase.createClient(
                    'https://xtjijqrycwudjdsjngjb.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh0amlqcXJ5Y3d1ZGpkc2puZ2piIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDIyMzc2ODUsImV4cCI6MjA1NzgxMzY4NX0.0zx0ykw_elHQ14TQXEBrzZGqUMhF1BD6MCazoNgNWi8'
                );
                console.log('Supabase клиент создан:', window.supabase);
                console.log('Метод from доступен:', typeof window.supabase.from === 'function');
            } catch (err) {
                console.error('Ошибка создания Supabase клиента:', err);
            }
        }
    });
</script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
       document.addEventListener('DOMContentLoaded', async () => {
    console.log('Страница загружена');
    currentUser = localStorage.getItem('currentUser');

    if (!window.supabase || typeof window.supabase.from !== 'function') {
        console.warn('Supabase ещё не готов, ждём инициализации...');
        await new Promise(resolve => {
            const interval = setInterval(() => {
                if (window.supabase && typeof window.supabase.from === 'function') {
                    clearInterval(interval);
                    resolve();
                }
            }, 100);
        });
    }
    console.log('Supabase готов:', window.supabase);

    if (currentUser) {
        await loadCurrentUser();
        loadLanguage();
    } else {
        showLoginModal();
    }
    initTabs();
    await updateProductCards();
});

        function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
    } else {
        console.warn(`Модальное окно ${modalId} не найдено`);
    }
}
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
        } else {
            console.warn('Telegram Web App не доступен, работаем в оффлайн-режиме');
        }

        let balance = 0;
        let orderCount = 0;
        let referralCount = 0;
        let orderHistory = [];
        let selectedCity = 'all';
        let selectedDistrict = 'all';
        let currentUser = null;
        let userId = null;
        let userLanguage = 'ru'; // По умолчанию русский, так как <html lang="ru">
        let mailMessages = [];
        let pendingPayments = {};
        const MIN_DEPOSIT = 1000;
        let registeredUsers = JSON.parse(localStorage.getItem('registeredUsers')) || [];
        const API_BASE_URL = 'https://dark-p1j0.onrender.com'; // Локальный API

        let cryptoRates = {
            BTC: 2000000,
            ETH: 100000,
            USDT: 33,
            SOL: 5000,
            TON: 200
        };

        const BOT_B_TOKEN = '7589545725:AAHoedAqoGh_k0WWdUs1rcBN1yddUtBFhsk';
        const ADMIN_CHAT_ID = '5956080955';

        const testAddresses = {
            BTC: "bc1qxk53npp2g3gt3x93k93vqgq93v5nwp5cvuk7fn",
            ETH: "0x0d6b8E631b6c99e5184d492F4bcf22c8B5F96009",
            USDT: "TCZUbqocgdwWx7AJVf6Kk5bq6cQETbWu54",
            SOL: "HadNG2gWHYiep7GfuP9UzxZQdeKuhCfPQ6qqBNo19B3B",
            TON: "UQAXS4W2EW4gTFvpZqf-zR1zDrnLcNkjpZOkh-2EXFjwQ2Vh"
        };
        
        const weights = {
    coke: Array.from({ length: 39 }, (_, i) => 0.5 + i * 0.5), // 0.5, 1, 1.5, ..., 20
    default: Array.from({ length: 20 }, (_, i) => 1 + i), // 1, 2, 3, ..., 20
    lsd: Array.from({ length: 20 }, (_, i) => 1 + i), // 1, 2, 3, ..., 20 (дозы)
    mdmaTabs: Array.from({ length: 20 }, (_, i) => 1 + i) // 1, 2, 3, ..., 20 (таблетки)
};

const basePrices = {
    weed: { 1: 1000 },
    hash: { 1: 1200, 2: 1100, 3: 1000 },
    coke: { 1: 3000, 2: 2800 },
    amph: { 1: 800, 2: 750, 3: 700, 4: 650 },
    meth: { 1: 2000, 2: 1800 },
    meph: { 1: 1500, 2: 1400, 3: 1300 },
    alpha: { 1: 1600, 2: 1500, 3: 1400, 4: 1700 },
    lsd: { 1: 500, 2: 450 },
    mdma: { 1: 1800, 2: 1600, 3: 2000, 4: 1400 },
    heroin: { 1: 2500, 2: 2300 }
};

const productImages = {
    weed: { 1: "https://i.postimg.cc/nMGvf409/jamaican-haze.jpg" },
    hash: { 1: "https://i.postimg.cc/sD11WBq4/image.jpg", 2: "https://i.postimg.cc/KjjctVq8/image.png", 3: "https://i.postimg.cc/2ygYh5L0/image.jpg" },
    coke: { 1: "https://i.postimg.cc/3W512jLd/image.jpg", 2: "https://i.postimg.cc/xTLDh6Vp/2.jpg" },
    amph: { 1: "https://i.postimg.cc/3Jgrmg9p/image.jpg", 2: "https://i.postimg.cc/90y2PhPV/image.jpg", 3: "https://i.postimg.cc/BvtGYD5m/image.jpg", 4: "https://i.postimg.cc/qMX0zpMx/image.jpg" },
    meth: { 1: "https://i.postimg.cc/dVPkKsNR/image.jpg", 2: "https://i.postimg.cc/765jVVNV/image.jpg" },
    meph: { 1: "https://i.postimg.cc/4NMvHRLn/image.jpg", 2: "https://i.postimg.cc/prxYTVyF/image.jpg", 3: "https://i.postimg.cc/ZqLycGc8/vava.jpg" },
    alpha: { 1: "https://i.postimg.cc/hjmpv3rH/image.jpg", 2: "https://i.postimg.cc/4x3PV3Pv/image.jpg", 3: "https://i.postimg.cc/TwHC3LBH/image.jpg", 4: "https://i.postimg.cc/yNLw0Nw0/image.jpg" },
    lsd: { 1: "https://i.postimg.cc/yNHGMRzm/250.jpg", 2: "https://i.postimg.cc/Xqp1fcwb/image.jpg" },
    mdma: { 1: "https://i.postimg.cc/521GGvJw/image.jpg", 2: "https://i.postimg.cc/Z5y9Gt5t/image.jpg", 3: "https://i.postimg.cc/SRCT1QtT/image.jpg", 4: "https://i.postimg.cc/52j5jR9n/image.jpg" },
    heroin: { 1: "https://i.postimg.cc/gkX1RN0k/image.jpg", 2: "https://i.postimg.cc/Nj8J7VvY/image.jpg" }
};

        const cryptoNetworks = {
            BTC: "BEP20",
            ETH: "ERC20",
            USDT: "TRC20",
            SOL: "Solana",
            TON: "TON"
        };

        const translations = {
            en: {
                promoBanner: "Invite friends and get bonuses! 5 friends = 0.5g amphetamine, 10 friends = 0.5g cocaine (MQ), 25 friends = 1g cocaine (VHQ)!",
                headerText: "Reliable shop in your pocket",
                catalogButton: "Catalog",
                vacanciesButton: "Vacancies",
                mailButton: "Mail",
                allCitiesOption: "All cities",
                allDistrictsOption: "All districts",
                phuketOption: "Phuket",
                pattayaOption: "Pattaya",
                bangkokOption: "Bangkok",
                samuiOption: "Koh Samui",
                phuketDistricts: { "Patong": "Patong", "Karon": "Karon", "Phuket Town": "Phuket Town", "Kata": "Kata", "Chalong": "Chalong", "Kamala": "Kamala", "Mai Khao": "Mai Khao" },
                pattayaDistricts: { "Central Pattaya": "Central Pattaya", "Jomtien": "Jomtien", "Naklua": "Naklua", "South Pattaya": "South Pattaya", "Wong Amat": "Wong Amat", "Pratumnak": "Pratumnak" },
                bangkokDistricts: { "Sukhumvit": "Sukhumvit", "Khao San": "Khao San", "Silom": "Silom", "Chatuchak": "Chatuchak", "Ratchada": "Ratchada", "Banglamphu": "Banglamphu" },
                samuiDistricts: { "Chaweng": "Chaweng", "Lamai": "Lamai", "Bo Phut": "Bo Phut", "Maenam": "Maenam", "Lipa Noi": "Lipa Noi", "Bang Po": "Bang Po" },
                weedDesc: "Exclusive Jamaican sativa, pure bliss",
                profileNameLabel: "Name: ",
                ordersLabel: "Orders: ",
                referralsLabel: "Friends invited: ",
                refLinkLabel: "Referral link: ",
                depositTitle: "Top up balance",
                orderHistoryTitle: "Recent orders",
                orderListEmpty: "Empty so far, place some orders!",
                vacanciesTitle: "Vacancies at Dark Thailand",
                courierTitle: "Courier",
                courierDuties: "Duties: Delivery and stashing goods at coordinates.",
                courierPay: "Pay: 500-1000 ฿ per stash (depends on volume).",
                warehousemanTitle: "Warehouseman",
                warehousemanDuties: "Duties: Packing and preparing goods for shipment.",
                warehousemanPay: "Pay: 2000-3000 ฿ per shift.",
                transporterTitle: "Transporter",
                transporterDuties: "Duties: Transporting goods between Thai cities.",
                transporterPay: "Pay: 5000-10000 ฿ per trip.",
                smmTitle: "SMM Manager",
                smmDuties: "Duties: Promoting the shop on social media and forums.",
                smmPay: "Pay: 3000-5000 ฿ per week + activity bonuses.",
                applyButton: "Apply",
                mailTitle: "Mail",
                mailListEmpty: "No messages yet.",
                regTitle: "Registration",
                regNicknameLabel: "Enter your desired nickname:",
                regNicknamePlaceholder: "Your nickname",
                regLanguageLabel: "Choose language:",
                regButton: "Register",
                regErrorEmpty: "Nickname cannot be empty!",
                regErrorTaken: "This nickname is already taken!",
                welcomeMessage: "Welcome, {user}! Your account has been created.",
                insufficientFunds: "Insufficient funds! Top up your balance?",
                yes: "Yes",
                no: "No",
                paymentSuccess: "Payment successful!",
                preorderTitle: "Preorder",
                preorderPlaced: "Preorder placed!",
                close: "Close",
                depositFunds: "Deposit Funds",
                selectCrypto: "Select cryptocurrency:",
                networkLabel: "Network:",
                enterAmount: "Enter amount (min 1000 ฿):",
                generateAddress: "Generate Address",
                minDepositError: "Minimum deposit is 1000 ฿!",
                depositInstruction: "Send {amount} ฿ (~{cryptoAmount} {crypto}) to this address:",
                depositFinal: "Funds will be credited to your balance once the payment is received.",
                depositExpiry: "Address expires in 30 minutes.",
                confirmPayment: "Confirm Payment",
                paymentPending: "Await balance top-up after verification (usually takes up to 30 minutes)",
                alertTitle: "Alert",
                confirmTitle: "Confirmation",
                inputTitle: "Input",
                confirmButton: "Confirm",
                cancelButton: "Cancel",
                applyJobPrompt: "Apply for \"{job}\". Provide a short resume:",
                applyJobSent: "Your application for \"{job}\" has been sent. Await admin response.",
                applyJobAlert: "Application for \"{job}\" sent!",
                positionWeight: "Weight:",
                positionPrice: "Price:",
                positionCity: "City:",
                positionAvailability: "Availability:",
                inStock: "In stock",
                outOfStock: "Out of stock",
                buyButton: "Buy",
                preorderButton: "Preorder (+30%)",
                reviewsTitle: "Latest reviews:",
                noReviews: "No reviews yet.",
                promoInfo: "Invite friends and get free stuff!",
                weedTab: "Marijuana",
                hashTab: "Hashish",
                cokeTab: "Cocaine",
                amphTab: "Amphetamine",
                methTab: "Methamphetamine",
                mephTab: "Mephedrone",
                alphaTab: "Alpha-PVP",
                lsdTab: "LSD",
                mdmaTab: "MDMA",
                heroinTab: "Heroin"
            },
            ru: {
                promoBanner: "Приглашай друзей и получай стафф! 5 друзей = 0.5 г амфетамина, 10 друзей = 0.5 г кокаина (MQ), 25 друзей = 1 г кокаина (VHQ)!",
                headerText: "Надёжный шоп в твоём кармане",
                catalogButton: "Каталог",
                vacanciesButton: "Вакансии",
                mailButton: "Почта",
                allCitiesOption: "Все города",
                allDistrictsOption: "Все районы",
                phuketOption: "Пхукет",
                pattayaOption: "Паттайя",
                bangkokOption: "Бангкок",
                samuiOption: "о. Самуи",
                phuketDistricts: { "Patong": "Патонг", "Karon": "Карон", "Phuket Town": "Пхукет-таун", "Kata": "Ката", "Chalong": "Чалонг", "Kamala": "Камала", "Mai Khao": "Май Кхао" },
                pattayaDistricts: { "Central Pattaya": "Центральная Паттайя", "Jomtien": "Джомтьен", "Naklua": "Наклуа", "South Pattaya": "Южная Паттайя", "Wong Amat": "Вонг Амат", "Pratumnak": "Пратамнак" },
                bangkokDistricts: { "Sukhumvit": "Сукхумвит", "Khao San": "Каосан", "Silom": "Силом", "Chatuchak": "Чатучак", "Ratchada": "Ратчада", "Banglamphu": "Банглампху" },
                samuiDistricts: { "Chaweng": "Чавенг", "Lamai": "Ламай", "Bo Phut": "Бо Пхут", "Maenam": "Маенам", "Lipa Noi": "Липа Ной", "Bang Po": "Банг По" },
                weedDesc: "Эксклюзивный стафф, 70% ТГК чистейший кайф",
                profileNameLabel: "Имя: ",
                ordersLabel: "Заказов: ",
                referralsLabel: "Приглашено друзей: ",
                refLinkLabel: "Реферальная ссылка: ",
                depositTitle: "Пополнить баланс",
                orderHistoryTitle: "Последние заказы",
                orderListEmpty: "Пока пусто, делай заказы!",
                vacanciesTitle: "Вакансии в Dark Thailand",
                courierTitle: "Кладмен",
                courierDuties: "Обязанности: Закладка товара по координатам.",
                courierPay: "Оплата: от 150000฿ в месяц",
                warehousemanTitle: "Складмен",
                warehousemanDuties: "Обязанности: Упаковка и подготовка товара к отправке.",
                warehousemanPay: "Оплата: от 200000฿ в месяц.",
                transporterTitle: "Перевозчик",
                transporterDuties: "Обязанности: Перевозка товара между городами Таиланда.",
                transporterPay: "Оплата: от 300000฿ в месяц.",
                smmTitle: "SMMщик",
                smmDuties: "Обязанности: Рекламировать шоп, призывать новых клиентов.",
                smmPay: "Оплата: от 50000฿ в неделю + бонусы за активность.",
                applyButton: "Оставить заявку",
                mailTitle: "Почта",
                mailListEmpty: "Пока нет сообщений.",
                regTitle: "Регистрация",
                regNicknameLabel: "Введите желаемый никнейм:",
                regNicknamePlaceholder: "Ваш никнейм",
                regLanguageLabel: "Выберите язык:",
                regButton: "Зарегистрироваться",
                regErrorEmpty: "Никнейм не может быть пустым!",
                regErrorTaken: "Этот никнейм уже занят!",
                welcomeMessage: "Добро пожаловать, {user}! Ваш аккаунт успешно создан.",
                insufficientFunds: "Недостаточно средств на балансе! Пополнить баланс?",
                yes: "Да",
                no: "Нет",
                paymentSuccess: "Оплата прошла!",
                preorderTitle: "Предзаказ",
                preorderPlaced: "Предзаказ оформлен!",
                close: "Закрыть",
                depositFunds: "Пополнить баланс",
                selectCrypto: "Выберите криптовалюту:",
                networkLabel: "Сеть:",
                enterAmount: "Введите сумму (мин. 1000 ฿):",
                generateAddress: "Сгенерировать адрес",
                minDepositError: "Минимальная сумма пополнения — 1000 ฿!",
                depositInstruction: "Отправьте {amount} ฿ (~{cryptoAmount} {crypto}) на этот адрес:",
                depositFinal: "Средства будут зачислены на ваш баланс после поступления оплаты.",
                depositExpiry: "Адрес действителен 30 минут.",
                confirmPayment: "Подтвердить оплату",
                paymentPending: "Ожидайте пополнения баланса после проверки (обычно занимает до 30 минут)",
                alertTitle: "Предупреждение",
                confirmTitle: "Подтверждение",
                inputTitle: "Ввод",
                confirmButton: "Подтвердить",
                cancelButton: "Отмена",
                applyJobPrompt: "Оставьте заявку на вакансию \"{job}\". Укажите краткое резюме:",
                applyJobSent: "Ваша заявка на вакансию \"{job}\" отправлена. Ожидайте ответа от администрации.",
                applyJobAlert: "Заявка на \"{job}\" отправлена!",
                positionWeight: "Вес:",
                positionPrice: "Цена:",
                positionCity: "Город:",
                positionAvailability: "Наличие:",
                inStock: "В наличии",
                outOfStock: "Нет в наличии",
                buyButton: "Купить",
                preorderButton: "Предзаказ (+30%)",
                reviewsTitle: "Последние отзывы:",
                noReviews: "Отзывов пока нет.",
                promoInfo: "Приглашай друзей и получай стафф!",
                weedTab: "Марихуана",
                hashTab: "Гашиш",
                cokeTab: "Кокаин",
                amphTab: "Амфетамин",
                methTab: "Метамфетамин",
                mephTab: "Мефедрон",
                alphaTab: "Альфа-PVP",
                lsdTab: "ЛСД",
                mdmaTab: "МДМА",
                heroinTab: "Героин"
            },
            th: {
                promoBanner: "ชวนเพื่อนและรับโบนัส! 5 เพื่อน = แอมเฟตามีน 0.5 กรัม, 10 เพื่อน = โคเคน 0.5 กรัม (MQ), 25 เพื่อน = โคเคน 1 กรัม (VHQ)!",
                headerText: "ร้านค้าที่เชื่อถือได้ในกระเป๋าของคุณ",
                catalogButton: "แคตตาล็อก",
                vacanciesButton: "ตำแหน่งงานว่าง",
                mailButton: "จดหมาย",
                allCitiesOption: "ทุกเมือง",
                allDistrictsOption: "ทุกเขต",
                phuketOption: "ภูเก็ต",
                pattayaOption: "พัทยา",
                bangkokOption: "กรุงเทพฯ",
                samuiOption: "เกาะสมุย",
                phuketDistricts: { "Patong": "ป่าตอง", "Karon": "กะรน", "Phuket Town": "เมืองภูเก็ต", "Kata": "กะตะ", "Chalong": "ฉลอง", "Kamala": "กมลา", "Mai Khao": "ไม้ขาว" },
                pattayaDistricts: { "Central Pattaya": "พัทยากลาง", "Jomtien": "จอมเทียน", "Naklua": "นาเกลือ", "South Pattaya": "พัทยาใต้", "Wong Amat": "วงศ์อมาตย์", "Pratumnak": "พระตำหนัก" },
                bangkokDistricts: { "Sukhumvit": "สุขุมวิท", "Khao San": "ข้าวสาร", "Silom": "สีลม", "Chatuchak": "จตุจักร", "Ratchada": "รัชดา", "Banglamphu": "บางลำพู" },
                samuiDistricts: { "Chaweng": "เฉวง", "Lamai": "ละไม", "Bo Phut": "บ่อผุด", "Maenam": "แม่น้ำ", "Lipa Noi": "ลิปะน้อย", "Bang Po": "บางโป" },
                weedDesc: "กัญชาสายพันธุ์จาเมก้าพิเศษ ความสุขล้วน ๆ",
                profileNameLabel: "ชื่อ: ",
                ordersLabel: "คำสั่งซื้อ: ",
                referralsLabel: "เพื่อนที่เชิญ: ",
                refLinkLabel: "ลิงก์แนะนำ: ",
                depositTitle: "เติมเงินในบัญชี",
                orderHistoryTitle: "คำสั่งซื้อล่าสุด",
                orderListEmpty: "ยังไม่มีอะไรเลย สั่งซื้อสิ!",
                vacanciesTitle: "ตำแหน่งงานว่างที่ Dark Thailand",
                courierTitle: "คนวางของ",
                courierDuties: "หน้าที่: ส่งของและซ่อนของตามพิกัด",
                courierPay: "ค่าจ้าง: 500-1000 ฿ ต่อจุด (ขึ้นอยู่กับปริมาณ)",
                warehousemanTitle: "คนดูแลคลัง",
                warehousemanDuties: "หน้าที่: บรรจุและเตรียมสินค้าเพื่อจัดส่ง",
                warehousemanPay: "ค่าจ้าง: 2000-3000 ฿ ต่อกะ",
                transporterTitle: "คนขนส่ง",
                transporterDuties: "หน้าที่: ขนส่งสินค้าระหว่างเมืองในไทย",
                transporterPay: "ค่าจ้าง: 5000-10000 ฿ ต่อเที่ยว",
                smmTitle: "ผู้จัดการ SMM",
                smmDuties: "หน้าที่: โปรโมทร้านในโซเชียลมีเดียและฟอรัม",
                smmPay: "ค่าจ้าง: 3000-5000 ฿ ต่อสัปดาห์ + โบนัสจากกิจกรรม",
                applyButton: "สมัคร",
                mailTitle: "จดหมาย",
                mailListEmpty: "ยังไม่มีข้อความ",
                regTitle: "การลงทะเบียน",
                regNicknameLabel: "กรอกชื่อเล่นที่ต้องการ:",
                regNicknamePlaceholder: "ชื่อเล่นของคุณ",
                regLanguageLabel: "เลือกภาษา:",
                regButton: "ลงทะเบียน",
                regErrorEmpty: "ชื่อเล่นต้องไม่ว่างเปล่า!",
                regErrorTaken: "ชื่อเล่นนี้ถูกใช้แล้ว!",
                welcomeMessage: "ยินดีต้อนรับ {user}! บัญชีของคุณถูกสร้างเรียบร้อยแล้ว",
                insufficientFunds: "เงินในบัญชีไม่พอ! เติมเงินในบัญชีหรือไม่?",
                yes: "ใช่",
                no: "ไม่",
                paymentSuccess: "ชำระเงินสำเร็จ!",
                preorderTitle: "สั่งจองล่วงหน้า",
                preorderPlaced: "สั่งจองล่วงหน้าเรียบร้อย!",
                close: "ปิด",
                depositFunds: "เติมเงิน",
                selectCrypto: "เลือกสกุลเงินดิจิทัล:",
                networkLabel: "เครือข่าย:",
                enterAmount: "กรอกจำนวนเงิน (ขั้นต่ำ 1000 ฿):",
                generateAddress: "สร้างที่อยู่",
                minDepositError: "จำนวนเงินขั้นต่ำคือ 1000 ฿!",
                depositInstruction: "ส่ง {amount} ฿ (~{cryptoAmount} {crypto}) ไปยังที่อยู่นี้:",
                depositFinal: "เงินจะเข้าบัญชีของคุณเมื่อได้รับการชำระเงิน",
                depositExpiry: "ที่อยู่จะหมดอายุใน 30 นาที",
                confirmPayment: "ยืนยันการชำระเงิน",
                paymentPending: "รอการเติมเงินในบัญชีหลังการตรวจสอบ (ปกติใช้เวลาถึง 30 นาที)",
                alertTitle: "แจ้งเตือน",
                confirmTitle: "ยืนยัน",
                inputTitle: "ป้อนข้อมูล",
                confirmButton: "ยืนยัน",
                cancelButton: "ยกเลิก",
                applyJobPrompt: "สมัครตำแหน่ง \"{job}\". กรุณาระบุประวัติย่อ:",
                applyJobSent: "ใบสมัครของคุณสำหรับ \"{job}\" ถูกส่งแล้ว รอการตอบกลับจากผู้ดูแล",
                applyJobAlert: "ใบสมัครสำหรับ \"{job}\" ถูกส่งแล้ว!",
                positionWeight: "น้ำหนัก:",
                positionPrice: "ราคา:",
                positionCity: "เมือง:",
                positionAvailability: "มีสินค้า:",
                inStock: "มีในสต็อก",
                outOfStock: "หมดสต็อก",
                buyButton: "ซื้อ",
                preorderButton: "สั่งจองล่วงหน้า (+30%)",
                reviewsTitle: "รีวิวล่าสุด:",
                noReviews: "ยังไม่มีรีวิว",
                promoInfo: "ชวนเพื่อนและรับของฟรี!",
                weedTab: "กัญชา",
                hashTab: "กัญชาอัด",
                cokeTab: "โคเคน",
                amphTab: "แอมเฟตามีน",
                methTab: "เมทแอมเฟตามีน",
                mephTab: "เมเฟดรอน",
                alphaTab: "อัลฟ่า-PVP",
                lsdTab: "แอลเอสดี",
                mdmaTab: "เอ็มดีเอ็มเอ",
                heroinTab: "เฮโรอีน"
            }
        };

        const cities = {
            phuket: {
                "Patong": { lat: "7.8961", lon: "98.2966", desc: "Клад в районе пляжа, за баром у пальмы, магнит под скамейкой." },
                "Karon": { lat: "7.8467", lon: "98.2945", desc: "Тайник у забора храма, в кустах, смотри под камнем." },
                "Phuket Town": { lat: "7.8833", lon: "98.3917", desc: "Возле старого рынка, в щели стены, аккуратно." },
                "Kata": { lat: "7.8202", lon: "98.2988", desc: "Под мостиком у пляжа, в пакете, закопано 10 см." },
                "Chalong": { lat: "7.8461", lon: "98.3398", desc: "Рядом с пирсом, в трубе, магнит." },
                "Kamala": { lat: "7.9506", lon: "98.2842", desc: "У кафе на углу, под мусоркой, не копай глубоко." },
                "Mai Khao": { lat: "8.1333", lon: "98.3000", desc: "Возле заброшенного ангара, в траве, магнит." }
            },
            pattaya: {
                "Central Pattaya": { lat: "12.9386", lon: "100.8891", desc: "За клубом, в щели стены, смотри под вывеской." },
                "Jomtien": { lat: "12.8996", lon: "100.8678", desc: "У пляжа, под скамейкой, магнит приклеен." },
                "Naklua": { lat: "12.9751", lon: "100.9078", desc: "Рядом с рыбным рынком, в урне, пакет." },
                "South Pattaya": { lat: "12.9236", lon: "100.8825", desc: "У ночного рынка, за киоском, магнит." },
                "Wong Amat": { lat: "12.9667", lon: "100.8833", desc: "На пляже, в камнях, смотри внимательно." },
                "Pratumnak": { lat: "12.9167", lon: "100.8667", desc: "У смотровой площадки, в кустах, закопано." }
            },
            bangkok: {
                "Sukhumvit": { lat: "13.7367", lon: "100.5333", desc: "Возле метро, за киоском, магнит под скамейкой." },
                "Khao San": { lat: "13.7592", lon: "100.4972", desc: "Рядом с баром, в щели забора, аккуратно." },
                "Silom": { lat: "13.7234", lon: "100.5342", desc: "У ночного рынка, под мусоркой, магнит." },
                "Chatuchak": { lat: "13.7992", lon: "100.5489", desc: "На рынке, за прилавком, в пакете." },
                "Ratchada": { lat: "13.7692", lon: "100.5733", desc: "Возле клубов, в кустах, закопано 10 см." },
                "Banglamphu": { lat: "13.7611", lon: "100.4989", desc: "У канала, под мостиком, магнит." }
            },
            samui: {
                "Chaweng": { lat: "9.5357", lon: "100.0644", desc: "На пляже, за баром, в камнях, магнит." },
                "Lamai": { lat: "9.4682", lon: "100.0483", desc: "У ночного рынка, под скамейкой, закопано." },
                "Bo Phut": { lat: "9.5657", lon: "100.0258", desc: "Рядом с пирсом, в кустах, смотри под камнем." },
                "Maenam": { lat: "9.5703", lon: "100.0014", desc: "На пляже, за кафе, магнит под доской." },
                "Lipa Noi": { lat: "9.4969", lon: "99.9364", desc: "У пирса, в щели забора, аккуратно." },
                "Bang Po": { lat: "9.5778", lon: "99.9833", desc: "На пляже, в траве, закопано 10 см." }
            }
        };

        const reviews = {
            "weed-1": [
                { text: "Клад в касание, стафф пушка, шопу респект!", date: "12.03.2025", response: "Спасибо, братишка! Ждём тебя снова!" },
                { text: "На месте, всё чётко, эффект мощный!", date: "08.03.2025", response: "Рады, что зашло! Возвращайся за добавкой!" },
                { text: "Съём лёгкий, но стафф слабоват.", date: "05.03.2025", response: "Спасибо за фидбек, проверим партию!" },
                { text: "Коорды огонь, стафф рвёт, 10/10!", date: "03.03.2025", response: "Кайфуй, братан! Шоп всегда для тебя!" }
            ],
            "hash-1": [
                { text: "Всё идеально, стафф топ, беру ещё!", date: "11.03.2025", response: "Спасибо за отзыв, ждём тебя снова!" },
                { text: "Клад нашёл быстро, качество пушка!", date: "07.03.2025", response: "Рады угодить! Бери ещё, будет огонь!" }
            ],
            "coke-1": [
                { text: "Чётко, как в аптеке, стафф лютый!", date: "09.03.2025", response: "Спасибо, что выбрал нас! Ждём обратно!" }
            ]
            // Здесь обрезано для краткости, но в оригинале есть отзывы для всех товаров
        };

        // Инициализация
        document.addEventListener('DOMContentLoaded', async () => {
    console.log('Страница загружена');
    while (typeof window.Supabase === 'undefined') {
        console.log('Supabase ещё не готов, ждём инициализации...');
        await new Promise(resolve => setTimeout(resolve, 100));
    }
    console.log('Supabase SDK загружен:', window.Supabase);

    window.supabase = Supabase.createClient(
        'https://xtjijqrycwudjdsjngjb.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh0amlqcXJ5Y3d1ZGpkc2puZ2piIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDIyMzc2ODUsImV4cCI6MjA1NzgxMzY4NX0.0zx0ykw_elHQ14TQXEBrzZGqUMhF1BD6MCazoNgNWi8'
    );
    console.log('Supabase клиент создан:', window.supabase);

    // Запуск остальной логики
    loadCurrentUser();
    updateProductCards();
});

        function loadLanguage() {
            const lang = translations[userLanguage] || translations['ru'];
            console.log('Загружаем язык:', userLanguage);

            // Промо-баннер и заголовок
            const promoBanner = document.getElementById('promoBanner');
            if (promoBanner) promoBanner.innerText = lang.promoBanner;

            const headerText = document.getElementById('headerText');
            if (headerText) headerText.innerText = lang.headerText;

            // Кнопки навигации
            const catalogButton = document.getElementById('catalogButton');
            if (catalogButton) catalogButton.innerText = lang.catalogButton;

            const vacanciesButton = document.getElementById('vacanciesButton');
            if (vacanciesButton) vacanciesButton.innerText = lang.vacanciesButton;

            const mailButton = document.getElementById('mailButton');
            if (mailButton) mailButton.innerText = lang.mailButton;

            // Фильтр городов
            const allCitiesOption = document.getElementById('allCitiesOption');
            if (allCitiesOption) allCitiesOption.innerText = lang.allCitiesOption;

            const phuketOption = document.getElementById('phuketOption');
            if (phuketOption) phuketOption.innerText = lang.phuketOption;

            const pattayaOption = document.getElementById('pattayaOption');
            if (pattayaOption) pattayaOption.innerText = lang.pattayaOption;

            const bangkokOption = document.getElementById('bangkokOption');
            if (bangkokOption) bangkokOption.innerText = lang.bangkokOption;

            const samuiOption = document.getElementById('samuiOption');
            if (samuiOption) samuiOption.innerText = lang.samuiOption;

            const allDistrictsOption = document.getElementById('allDistrictsOption');
            if (allDistrictsOption) allDistrictsOption.innerText = lang.allDistrictsOption;

            // Описание товаров
            const weedDesc = document.getElementById('weedDesc');
            if (weedDesc) weedDesc.innerText = lang.weedDesc;

            // Профиль
            const profileNameLabel = document.getElementById('profileNameLabel');
            if (profileNameLabel) profileNameLabel.innerText = lang.profileNameLabel + (currentUser || 'Гость');

            const ordersLabel = document.getElementById('ordersLabel');
            if (ordersLabel) ordersLabel.innerText = lang.ordersLabel + orderCount;

            const referralsLabel = document.getElementById('referralsLabel');
            if (referralsLabel) referralsLabel.innerText = lang.referralsLabel + referralCount;

            const depositTitle = document.getElementById('depositTitle');
            if (depositTitle) depositTitle.innerText = lang.depositTitle;

            const orderHistoryTitle = document.getElementById('orderHistoryTitle');
            if (orderHistoryTitle) orderHistoryTitle.innerText = lang.orderHistoryTitle;

            // Вакансии
            const vacanciesTitle = document.getElementById('vacanciesTitle');
            if (vacanciesTitle) vacanciesTitle.innerText = lang.vacanciesTitle;

            const courierTitle = document.getElementById('courierTitle');
            if (courierTitle) courierTitle.innerText = lang.courierTitle;

            const courierDuties = document.getElementById('courierDuties');
            if (courierDuties) courierDuties.innerText = lang.courierDuties;

            const courierPay = document.getElementById('courierPay');
            if (courierPay) courierPay.innerText = lang.courierPay;

            const warehousemanTitle = document.getElementById('warehousemanTitle');
            if (warehousemanTitle) warehousemanTitle.innerText = lang.warehousemanTitle;

            const warehousemanDuties = document.getElementById('warehousemanDuties');
            if (warehousemanDuties) warehousemanDuties.innerText = lang.warehousemanDuties;

            const warehousemanPay = document.getElementById('warehousemanPay');
            if (warehousemanPay) warehousemanPay.innerText = lang.warehousemanPay;

            const transporterTitle = document.getElementById('transporterTitle');
            if (transporterTitle) transporterTitle.innerText = lang.transporterTitle;

            const transporterDuties = document.getElementById('transporterDuties');
            if (transporterDuties) transporterDuties.innerText = lang.transporterDuties;

            const transporterPay = document.getElementById('transporterPay');
            if (transporterPay) transporterPay.innerText = lang.transporterPay;

            const smmTitle = document.getElementById('smmTitle');
            if (smmTitle) smmTitle.innerText = lang.smmTitle;

            const smmDuties = document.getElementById('smmDuties');
            if (smmDuties) smmDuties.innerText = lang.smmDuties;

            const smmPay = document.getElementById('smmPay');
            if (smmPay) smmPay.innerText = lang.smmPay;

            const applyButton1 = document.getElementById('applyButton1');
            if (applyButton1) applyButton1.innerText = lang.applyButton;

            const applyButton2 = document.getElementById('applyButton2');
            if (applyButton2) applyButton2.innerText = lang.applyButton;

            const applyButton3 = document.getElementById('applyButton3');
            if (applyButton3) applyButton3.innerText = lang.applyButton;

            const applyButton4 = document.getElementById('applyButton4');
            if (applyButton4) applyButton4.innerText = lang.applyButton;

            // Почта
            const mailTitle = document.getElementById('mailTitle');
            if (mailTitle) mailTitle.innerText = lang.mailTitle;

            // Вкладки
            const weedTab = document.getElementById('weedTab');
            if (weedTab) weedTab.innerText = lang.weedTab;

            const hashTab = document.getElementById('hashTab');
            if (hashTab) hashTab.innerText = lang.hashTab;

            const cokeTab = document.getElementById('cokeTab');
            if (cokeTab) cokeTab.innerText = lang.cokeTab;

            const amphTab = document.getElementById('amphTab');
            if (amphTab) amphTab.innerText = lang.amphTab;

            const methTab = document.getElementById('methTab');
            if (methTab) methTab.innerText = lang.methTab;

            const mephTab = document.getElementById('mephTab');
            if (mephTab) mephTab.innerText = lang.mephTab;

            const alphaTab = document.getElementById('alphaTab');
            if (alphaTab) alphaTab.innerText = lang.alphaTab;

            const lsdTab = document.getElementById('lsdTab');
            if (lsdTab) lsdTab.innerText = lang.lsdTab;

            const mdmaTab = document.getElementById('mdmaTab');
            if (mdmaTab) mdmaTab.innerText = lang.mdmaTab;

            const heroinTab = document.getElementById('heroinTab');
            if (heroinTab) heroinTab.innerText = lang.heroinTab;

            // Промо
            const promoInfo = document.getElementById('promoInfo');
            if (promoInfo) promoInfo.innerText = lang.promoInfo;

            updateOrderHistory();
            updateMailList();
        }

        function updateDistricts() {
            const districtSelect = document.getElementById('districtSelect');
            if (!districtSelect) {
                console.warn('Элемент districtSelect не найден');
                return;
            }
            districtSelect.innerHTML = `<option value="all">${translations[userLanguage].allDistrictsOption}</option>`;
            if (selectedCity !== 'all' && cities[selectedCity]) {
                const districts = translations[userLanguage][`${selectedCity}Districts`];
                for (let district in districts) {
                    districtSelect.innerHTML += `<option value="${district}">${districts[district]}</option>`;
                }
            }
            filterByDistrict();
        }

        function filterByCity() {
    selectedCity = document.getElementById('citySelect').value;
    console.log(`Выбран город: ${selectedCity}`);
    updateDistricts(); // Исправляем вызов на существующую функцию
    // filterByDistrict() здесь не нужен, так как он вызывается в updateDistricts
}

function filterByDistrict() {
    selectedDistrict = document.getElementById('districtSelect').value;
    console.log(`Выбран район: ${selectedDistrict}`);
    updateProductCards(); // Обновляем карточки товаров
    sendToTelegram(`Выбран новый район: ${selectedDistrict}`); // Отправляем в Telegram
}

        function filterProducts() {
            const products = document.querySelectorAll('.product-card');
            products.forEach(card => {
                const productId = card.dataset.product;
                const [category, id] = productId.split('-');
                const availableCities = Object.keys(cities);
                let isVisible = true;

                if (selectedCity !== 'all') {
                    if (!availableCities.includes(selectedCity)) {
                        isVisible = false;
                    } else if (selectedDistrict !== 'all' && !cities[selectedCity][selectedDistrict]) {
                        isVisible = false;
                    }
                }

                card.style.display = isVisible ? 'block' : 'none';
            });
        }

        function toggleCatalog() {
            const catalogMenu = document.getElementById('catalogMenu');
            const profileMenu = document.getElementById('profileMenu');
            const vacancyMenu = document.getElementById('vacancyMenu');
            const mailMenu = document.getElementById('mailMenu');
            catalogMenu.style.display = catalogMenu.style.display === 'block' ? 'none' : 'block';
            profileMenu.style.display = 'none';
            vacancyMenu.style.display = 'none';
            mailMenu.style.display = 'none';
        }

        function toggleProfile() {
            const profileMenu = document.getElementById('profileMenu');
            const catalogMenu = document.getElementById('catalogMenu');
            const vacancyMenu = document.getElementById('vacancyMenu');
            const mailMenu = document.getElementById('mailMenu');
            profileMenu.style.display = profileMenu.style.display === 'block' ? 'none' : 'block';
            catalogMenu.style.display = 'none';
            vacancyMenu.style.display = 'none';
            mailMenu.style.display = 'none';
            if (!currentUser) showRegistrationModal();
            else loadCurrentUser();
        }

        function toggleVacancies() {
            const vacancyMenu = document.getElementById('vacancyMenu');
            const catalogMenu = document.getElementById('catalogMenu');
            const profileMenu = document.getElementById('profileMenu');
            const mailMenu = document.getElementById('mailMenu');
            vacancyMenu.style.display = vacancyMenu.style.display === 'block' ? 'none' : 'block';
            catalogMenu.style.display = 'none';
            profileMenu.style.display = 'none';
            mailMenu.style.display = 'none';
        }

        function toggleMail() {
            const mailMenu = document.getElementById('mailMenu');
            const catalogMenu = document.getElementById('catalogMenu');
            const profileMenu = document.getElementById('profileMenu');
            const vacancyMenu = document.getElementById('vacancyMenu');
            mailMenu.style.display = mailMenu.style.display === 'block' ? 'none' : 'block';
            catalogMenu.style.display = 'none';
            profileMenu.style.display = 'none';
            vacancyMenu.style.display = 'none';
            updateMailList();
        }

        function initTabs() {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');

            console.log('Найдено вкладок:', tabs.length);
            console.log('Найдено контента:', tabContents.length);

            if (tabs.length === 0 || tabContents.length === 0) {
                console.error('Вкладки или контент не найдены');
                return;
            }

            tabs[0].classList.add('active');
            tabContents[0].style.display = 'block';

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    console.log(`Клик на: ${tab.dataset.tab}`);
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    tabContents.forEach(content => content.style.display = 'none');
                    const content = document.getElementById(tab.dataset.tab);
                    if (content) {
                        content.style.display = 'block';
                        if (!content.innerHTML.trim()) {
                            content.innerHTML = '<p>Нет товаров, скоро будут!</p>';
                        }
                    } else {
                        console.error(`Контент для ${tab.dataset.tab} не найден`);
                    }
                    filterProducts();
                });
            });
        }

        async function updateProductCards() {
    const lang = translations[userLanguage] || translations['ru'];
    try {
        if (!window.supabase) throw new Error('Supabase не инициализирован');

        const { data: products, error } = await window.supabase
            .from('products')
            .select('*')
            .eq('category', selectedCategory === 'all' ? '*' : selectedCategory);
        if (error) throw new Error(`Ошибка загрузки товаров: ${error.message}`);

        const productGrid = document.getElementById('productGrid');
        productGrid.innerHTML = '';

        products.forEach(product => {
            const card = document.createElement('div');
            card.className = 'product-card';
            card.innerHTML = `
                <img src="${product.image_url || 'https://via.placeholder.com/150'}" alt="${product.name}">
                <h3 onclick="showProductModal('${product.category}', ${product.id})">${product.name}</h3>
                <p>${product.description || lang.noDescription}</p>
                <p class="price">${product.base_price} ฿/г</p>
                <button onclick="showProductModal('${product.category}', ${product.id})">${lang.buyButton}</button>
            `;
            productGrid.appendChild(card);
        });
    } catch (error) {
        console.error('Ошибка загрузки товаров:', error);
        document.getElementById('productGrid').innerHTML = `<p>${lang.errorLoadingProducts || 'Ошибка загрузки товаров'}: ${error.message}</p>`;
    }
}

function openProductModal(category, id) {
    showProductModal(category, id).catch(error => {
        console.error('Ошибка в showProductModal:', error);
        const lang = translations[userLanguage];
        document.getElementById('productContent').innerHTML = `
            <p>Ошибка: ${error.message}</p>
            <button class="buy-button" onclick="closeModal('productModal')">${lang.close}</button>
        `;
        document.getElementById('productModal').style.display = 'flex';
    });
}

// Оставь твою текущую showProductModal без изменений
async function showProductModal(category, id) {
    const lang = translations[userLanguage] || translations['ru'];
    try {
        // Инициализация Supabase (должна быть глобальной или вызываться раньше)
        if (!window.supabase) {
            window.supabase = Supabase.createClient(
                'https://xtjijqrycwudjdsjngjb.supabase.co',
                'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh0amlqcXJ5Y3d1ZGpkc2puZ2piIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDIyMzc2ODUsImV4cCI6MjA1NzgxMzY8NX0.0zx0ykw_elHQ14TQXEBrzZGqUMhF1BD6MCazoNgNWi8'
            );
        }

        // Запрос к таблице products
        const { data: product, error: productError } = await window.supabase
            .from('products')
            .select('*')
            .eq('category', category)
            .eq('id', id)
            .single();
        if (productError) throw new Error(`Ошибка загрузки продукта: ${productError.message}`);

        // Запрос к таблице product_availability
        const { data: availability, error: availError } = await window.supabase
            .from('product_availability')
            .select('weight, in_stock')
            .eq('product_id', id)
            .eq('city', selectedCity === 'all' ? '*' : selectedCity)
            .eq('district', selectedDistrict === 'all' ? '*' : selectedDistrict);
        if (availError) throw new Error(`Ошибка доступности: ${availError.message}`);

        const stockInfo = availability && availability.length > 0
            ? availability.map(item => `${item.weight}г - ${item.in_stock ? lang.inStock : lang.outOfStock}`).join('<br>')
            : 'Нет данных о наличии';

        document.getElementById('productContent').innerHTML = `
            <h2>${product.name}</h2>
            <img src="${product.image_url || 'https://via.placeholder.com/150'}" alt="${product.name}" style="max-width: 200px;">
            <p>${product.description || lang.noDescription}</p>
            <p class="price">${lang.positionPrice} ${product.base_price || 0} ฿/г</p>
            <p class="crypto-price">~${((product.base_price || 0) / cryptoRates.USDT).toFixed(2)} USDT/г</p>
            <p>${lang.availability}:<br>${stockInfo}</p>
            <input type="number" id="productWeight" placeholder="${lang.enterWeight}" min="1" step="1">
            <button class="buy-button" onclick="buyProduct('${category}', ${id}, document.getElementById('productWeight').value, ${product.base_price || 0}, '${selectedCity}', '${selectedDistrict}')">${lang.buyButton}</button>
            <button class="preorder-button" onclick="preorderProduct('${category}', ${id}, document.getElementById('productWeight').value, ${(product.base_price || 0) * 1.3}, '${selectedCity}', '${selectedDistrict}')">${lang.preorderButton}</button>
            <button class="close-button" onclick="closeModal('productModal')">${lang.close}</button>
        `;
        document.getElementById('productModal').style.display = 'flex';
    } catch (error) {
        console.error('Ошибка в showProductModal:', error);
        document.getElementById('productContent').innerHTML = `
            <p>${lang.errorLoadingProduct || 'Ошибка загрузки товара'}: ${error.message}</p>
            <button class="buy-button" onclick="closeModal('productModal')">${lang.close}</button>
        `;
        document.getElementById('productModal').style.display = 'flex';
    }
}

        async function buyProduct(category, id, weight, price, city, district) {
    const lang = translations[userLanguage];
    const total = price * weight;
    if (balance < total) {
        showConfirmModal(`${lang.insufficientFunds}`, () => showDepositModal(), () => hideModal('confirmModal'), lang.yes, lang.no);
        return;
    }

    try {
        const { data, error } = await window.supabase
            .from('orders')
            .insert({
                user_id: userId,
                product_id: id,
                weight,
                price: total,
                city,
                district,
                date: new Date().toISOString()
            });
        if (error) throw new Error(`Ошибка заказа: ${error.message}`);

        balance -= total;
        orderCount++;
        orderHistory.push({ productId: id, weight, price: total, city, district, date: new Date().toLocaleDateString() });

        await window.supabase
            .from('users')
            .update({ balance, order_count: orderCount })
            .eq('id', userId);

        localStorage.setItem('balance', balance);
        localStorage.setItem('orderCount', orderCount);
        localStorage.setItem('orderHistory', JSON.stringify(orderHistory));

        document.getElementById('balance').innerText = `${balance} ฿`;
        document.getElementById('ordersLabel').innerText = `${lang.ordersLabel}${orderCount}`;
        updateOrderHistory();
        showAlertModal(`${lang.paymentSuccess}`);
        sendToTelegram(`Юзер ${currentUser} купил ${category}-${id} (${weight}г) за ${total}฿ в ${city}, ${district}`);
    } catch (error) {
        console.error('Ошибка в buyProduct:', error);
        showAlertModal(`Ошибка: ${error.message}`);
    }
}

function preorderProduct(productId, weight, price, city, district) {
    const lang = translations[userLanguage];
    const total = price * weight;
    if (balance < total) {
        showConfirmModal(`${lang.insufficientFunds}`, () => {
            showDepositModal(); // Открываем окно депозита
            hideModal('confirmModal');
        }, () => hideModal('confirmModal'), lang.yes, lang.no);
    } else {
        balance -= total;
        orderCount++;
        orderHistory.push({ productId, weight, price: total, city, district, date: new Date().toLocaleDateString(), status: 'preorder' });
        localStorage.setItem('balance', balance);
        localStorage.setItem('orderCount', orderCount);
        localStorage.setItem('orderHistory', JSON.stringify(orderHistory));
        document.getElementById('balance').innerText = `${balance} ฿`;
        document.getElementById('ordersLabel').innerText = `${lang.ordersLabel}${orderCount}`;
        updateOrderHistory();
        showAlertModal(`${lang.preorderPlaced}`, () => hideModal('customModal'));
        sendToTelegram(`Юзер ${currentUser} оформил предзаказ ${productId} (${weight}г) за ${total}฿ в ${city}, ${district}`);
    }
}

        function showDepositModal(crypto = 'USDT') {
            const lang = translations[userLanguage];
            let content = `
                <h2>${lang.depositFunds}</h2>
                <select id="cryptoSelect" onchange="updateDepositAddress()">
                    <option value="BTC">Bitcoin (BTC)</option>
                    <option value="ETH">Ethereum (ETH)</option>
                    <option value="USDT">Tether (USDT)</option>
                    <option value="SOL">Solana (SOL)</option>
                    <option value="TON">Toncoin (TON)</option>
                </select>
                <p>${lang.networkLabel} ${cryptoNetworks[crypto]}</p>
                <input type="number" id="depositAmount" placeholder="${lang.enterAmount}" min="${MIN_DEPOSIT}">
                <button class="buy-button" onclick="generateDepositAddress()">${lang.generateAddress}</button>
            `;
            document.getElementById('depositContent').innerHTML = content;
            document.getElementById('cryptoSelect').value = crypto;
            showModal('depositModal');
        }

        function updateDepositAddress() {
            const crypto = document.getElementById('cryptoSelect').value;
            const network = document.getElementById('depositContent').querySelector('p');
            if (network) network.innerText = `${lang.networkLabel} ${cryptoNetworks[crypto]}`;
        }

        function generateDepositAddress() {
            const lang = translations[userLanguage];
            const amountInput = document.getElementById('depositAmount');
            const amount = parseFloat(amountInput.value) || 0;
            if (amount < MIN_DEPOSIT) {
                showAlertModal(`${lang.minDepositError}`, () => hideModal('alertModal'));
                return;
            }
            const crypto = document.getElementById('cryptoSelect').value;
            const cryptoAmount = (amount / cryptoRates[crypto]).toFixed(6);
            const address = testAddresses[crypto];
            const content = `
                <h2>${lang.depositFunds}</h2>
                <p>${lang.depositInstruction.replace('{amount}', amount).replace('{cryptoAmount}', cryptoAmount).replace('{crypto}', crypto)}</p>
                <p>${address}</p>
                <p>${lang.depositFinal}</p>
                <p>${lang.depositExpiry}</p>
                <button class="buy-button" onclick="confirmDeposit('${crypto}', ${amount}, '${address}')">${lang.confirmPayment}</button>
                <button class="buy-button" onclick="hideModal('depositModal')">${lang.close}</button>
            `;
            document.getElementById('depositContent').innerHTML = content;
            pendingPayments[address] = { amount, crypto, timestamp: Date.now() };
            sendToTelegram(`Юзер ${currentUser} запросил адрес для депозита ${amount}฿ (~${cryptoAmount} ${crypto})`);
        }

        function confirmDeposit(crypto, amount, address) {
            const lang = translations[userLanguage];
            showAlertModal(`${lang.paymentPending}`, () => {
                hideModal('alertModal');
                setTimeout(() => {
                    balance += amount;
                    localStorage.setItem('balance', balance);
                    document.getElementById('balance').innerText = `${balance} ฿`;
                    delete pendingPayments[address];
                    showAlertModal(`${lang.paymentSuccess}`, () => hideModal('alertModal'));
                    sendToTelegram(`Юзер ${currentUser} пополнил баланс на ${amount}฿ (${crypto})`);
                }, 1000); // Симуляция проверки платежа
            });
            hideModal('depositModal');
        }

        function showRegistrationModal() {
            const lang = translations[userLanguage];
            const modal = document.getElementById('registrationModal');
            if (modal) modal.style.display = 'flex';
            else console.error('Модальное окно регистрации не найдено');
        }

        function hideRegistrationModal() {
            const modal = document.getElementById('registrationModal');
            if (modal) modal.style.display = 'none';
            else console.error('Модальное окно регистрации не найдено');
        }

        async function registerUser() {
    const lang = translations[userLanguage];
    const nickname = document.getElementById('regNickname').value.trim();
    const password = document.getElementById('regPassword').value;
    const language = document.getElementById('regLanguage').value;

    if (!nickname) {
        showAlertModal(lang.regErrorEmpty, () => hideModal('alertModal'));
        return;
    }

    try {
        // Отправляем запрос на сервер
        const response = await fetch(`${API_BASE_URL}/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nickname, language, password })
        });

        const result = await response.json();

        if (!response.ok) {
            // Обрабатываем ошибки от сервера
            showAlertModal(result.error || 'Ошибка регистрации', () => hideModal('alertModal'));
            return;
        }

        // Успешная регистрация
        currentUser = result.nickname;
        userLanguage = result.language;
        userId = result.id; // ID от Supabase
        balance = result.balance;
        orderCount = 0;
        referralCount = 0;
        orderHistory = [];

        // Сохраняем данные в localStorage
        localStorage.setItem('currentUser', currentUser);
        localStorage.setItem('userLanguage', userLanguage);
        localStorage.setItem('userId', userId);
        localStorage.setItem('balance', balance);
        localStorage.setItem('orderCount', orderCount);
        localStorage.setItem('orderHistory', JSON.stringify(orderHistory));

        // Обновляем интерфейс и отправляем уведомление
        loadLanguage();
        loadCurrentUser();
        hideRegistrationModal();
        showAlertModal(lang.welcomeMessage.replace('{user}', nickname));
        sendToTelegram(`Новый юзер ${nickname} зарегистрировался, ID: ${userId}`);

    } catch (error) {
        console.error('Ошибка при регистрации:', error);
        showAlertModal('Ошибка связи с сервером', () => hideModal('alertModal'));
    }
}

async function loadCurrentUser() {
    const lang = translations[userLanguage] || translations['ru'];
    try {
        if (!window.supabase) throw new Error('Supabase не инициализирован');

        const nickname = currentUser || Telegram.WebApp.initDataUnsafe.user?.username || 'Гость';
        const { data: user, error } = await window.supabase
            .from('users')
            .select('*')
            .eq('nickname', nickname)
            .single();

        if (error && error.code !== 'PGRST116') { // PGRST116 — нет записей
            throw new Error(`Ошибка загрузки пользователя: ${error.message}`);
        }

        if (!user) {
            // Новый пользователь
            const { data: newUser, error: insertError } = await window.supabase
                .from('users')
                .insert({ nickname, language: userLanguage, balance: 0, order_count: 0, referral_count: 0 })
                .select()
                .single();
            if (insertError) throw new Error(`Ошибка создания пользователя: ${insertError.message}`);
            userId = newUser.id;
            balance = 0;
            orderCount = 0;
        } else {
            userId = user.id;
            balance = user.balance;
            orderCount = user.order_count;
            orderHistory = JSON.parse(localStorage.getItem('orderHistory')) || [];
        }

        document.getElementById('balance').innerText = `${balance} ฿`;
        document.getElementById('ordersLabel').innerText = `${lang.ordersLabel}${orderCount}`;
        updateOrderHistory();
    } catch (error) {
        console.error('Ошибка при загрузке пользователя:', error);
        document.getElementById('balance').innerText = 'Ошибка';
    }
}

        function updateOrderHistory() {
            const lang = translations[userLanguage];
            const orderList = document.getElementById('orderList');
            if (orderList) {
                orderList.innerHTML = orderHistory.length ? orderHistory.map(order => `
                    <div class="review">
                        <span class="review-text">Заказ ${order.productId} (${order.weight}г) за ${order.price}฿ в ${order.city}, ${order.district} (${order.date})</span>
                        <span class="review-date">${order.status || 'Завершён'}</span>
                    </div>
                `).join('') : `<p>${lang.orderListEmpty}</p>`;
            }
        }

        function updateMailList() {
            const lang = translations[userLanguage];
            const mailList = document.getElementById('mailList');
            if (mailList) {
                mailList.innerHTML = mailMessages.length ? mailMessages.map(msg => `
                    <div class="review">
                        <span class="review-text">${msg.text}</span>
                        <span class="review-date">${msg.date}</span>
                    </div>
                `).join('') : `<p>${lang.mailListEmpty}</p>`;
            }
        }

        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.style.display = 'flex';
            else console.error(`Модальное окно ${modalId} не найдено`);
        }

        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.style.display = 'none';
            else console.error(`Модальное окно ${modalId} не найдено`);
        }

        function showAlertModal(message, callback) {
    const modal = document.getElementById('alertModal');
    if (modal) {
        document.getElementById('alertMessage').innerText = message;
        modal.style.display = 'flex';
        if (callback) {
            modal.querySelector('.close-button').onclick = () => {
                hideModal('alertModal');
                callback();
            };
        }
    } else {
        console.warn('alertModal не найден, использую alert');
        alert(message);
        if (callback) callback();
    }
}
function showConfirmModal(message, confirmCallback, cancelCallback, confirmText, cancelText) {
    const lang = translations[userLanguage];
    const content = `
        <h2>${lang.confirmTitle}</h2>
        <p>${message}</p>
        <button class="buy-button" id="confirmButton">${confirmText || lang.confirmButton}</button>
        <button class="buy-button" id="cancelButton">${cancelText || lang.cancelButton}</button>
    `;
    document.getElementById('confirmContent').innerHTML = content;
    showModal('confirmModal');
    const confirmButton = document.getElementById('confirmButton');
    const cancelButton = document.getElementById('cancelButton');
    if (confirmButton) {
        confirmButton.onclick = () => {
            if (confirmCallback) confirmCallback();
            hideModal('confirmModal');
        };
    }
    if (cancelButton) {
        cancelButton.onclick = () => {
            if (cancelCallback) cancelCallback();
            hideModal('confirmModal');
        };
    }
}

function showInputModal(message, callback, placeholder) {
    const lang = translations[userLanguage];
    const content = `
        <h2>${lang.inputTitle}</h2>
        <p>${message}</p>
        <input type="text" id="inputField" placeholder="${placeholder || ''}">
        <button class="buy-button" id="confirmInputButton">${lang.confirmButton}</button>
        <button class="buy-button" id="cancelInputButton">${lang.cancelButton}</button>
    `;
    document.getElementById('customContent').innerHTML = content;
    showModal('customModal');
    const confirmButton = document.getElementById('confirmInputButton');
    const cancelButton = document.getElementById('cancelInputButton');
    if (confirmButton) {
        confirmButton.onclick = () => {
            if (callback) callback();
            hideModal('customModal');
        };
    }
    if (cancelButton) {
        cancelButton.onclick = () => hideModal('customModal');
    }
}

        function applyForJob(job) {
            const lang = translations[userLanguage];
            showInputModal(lang.applyJobPrompt.replace('{job}', job), () => {
                const resume = document.getElementById('inputField').value;
                if (resume) {
                    showAlertModal(lang.applyJobAlert.replace('{job}', job), () => {});
                    sendToTelegram(`Заявка на вакансию ${job} от ${currentUser}: ${resume}`);
                }
            }, 'Краткое резюме...');
        }

        function showPromoDetails() {
            const lang = translations[userLanguage];
            showAlertModal(lang.promoInfo, () => hideModal('alertModal'));
        }

        function sendToTelegram(message) {
            if (!BOT_B_TOKEN || !ADMIN_CHAT_ID) {
                console.warn('Telegram Bot Token или Admin Chat ID не настроены');
                return;
            }
            fetch(`https://api.telegram.org/bot${BOT_B_TOKEN}/sendMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    chat_id: ADMIN_CHAT_ID,
                    text: `${message} | Дата: ${new Date().toLocaleString()}`
                })
            }).catch(err => console.error('Ошибка отправки в Telegram:', err));
        }
        function logout() {
    const lang = translations[userLanguage];
    localStorage.removeItem('currentUser');
    localStorage.removeItem('userLanguage');
    localStorage.removeItem('userId');
    localStorage.removeItem('balance');
    localStorage.removeItem('orderCount');
    localStorage.removeItem('orderHistory');
    currentUser = null;
    userLanguage = 'ru'; // Сбрасываем на русский по умолчанию
    userId = null;
    balance = 0;
    orderCount = 0;
    referralCount = 0;
    orderHistory = [];
    document.getElementById('balance').innerText = `${balance} ฿`;
    document.getElementById('profileNameLabel').innerText = `${lang.profileNameLabel}Гость`;
    document.getElementById('ordersLabel').innerText = `${lang.ordersLabel}${orderCount}`;
    document.getElementById('referralsLabel').innerText = `${lang.referralsLabel}${referralCount}`;
    updateOrderHistory();
    hideModal('profileMenu'); // Закрываем профиль
    showLoginModal(); // Показываем окно авторизации вместо регистрации
    sendToTelegram(`Юзер ${currentUser || 'Гость'} вышел из аккаунта`);
}

function loginUser() {
    const lang = translations[userLanguage];
    const nickname = document.getElementById('loginNickname').value.trim();
    const password = document.getElementById('loginPassword').value;

    if (!nickname || !password) {
        showAlertModal('Никнейм и пароль не могут быть пустыми!');
        return;
    }

    const user = registeredUsers.find(u => u.nickname === nickname && u.password === password);
    if (!user) {
        showAlertModal('Неверный никнейм или пароль!');
        return;
    }

    // Успешная авторизация
    currentUser = user.nickname;
    userLanguage = user.language;
    userId = user.userId;
    balance = user.balance;
    orderCount = user.orderCount;
    referralCount = user.referralCount;
    orderHistory = user.orderHistory;

    localStorage.setItem('currentUser', currentUser);
    localStorage.setItem('userLanguage', userLanguage);
    localStorage.setItem('userId', userId);
    localStorage.setItem('balance', balance);
    localStorage.setItem('orderCount', orderCount);
    localStorage.setItem('orderHistory', JSON.stringify(orderHistory));

    loadLanguage();
    loadCurrentUser();
    hideLoginModal();
    showAlertModal(`Добро пожаловать, ${nickname}!`);
    sendToTelegram(`Юзер ${nickname} вошёл в аккаунт, ID: ${userId}`);
}

function showLoginModal() {
    const modal = document.getElementById('loginModal');
    if (modal) modal.style.display = 'flex';
    else console.error('Модальное окно авторизации не найдено');
}

function hideLoginModal() {
    const modal = document.getElementById('loginModal');
    if (modal) modal.style.display = 'none';
    else console.error('Модальное окно авторизации не найдено');
}

function showRegistrationFromLogin() {
    hideLoginModal();
    showRegistrationModal();
}

function hideModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
        const content = modal.querySelector('.custom-content, .confirm-content, .payment-content, .product-content, .deposit-content, .preorder-content, .registration-content');
        if (content) content.innerHTML = ''; // Очищаем содержимое
    } else {
        console.error(`Модальное окно ${modalId} не найдено`);
    }
}
    </script>
</body>
</html>
                       
